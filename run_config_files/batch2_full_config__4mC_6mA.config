set -Eeuo pipefail # https://stackoverflow.com/a/821419

#-----------------------------
# To run this:
#  1. `git clone git@gitlab.oit.duke.edu:granek-lab/projects/dorado-pipelines.git`
#  2. `dorado-pipelines/basecall_demux_map/main_sbatch.sh PATH_TO_THIS_CONFIG`

#-----------------------------
export DORADO_SIF_PATH='docker://nanoporetech/dorado:sha0fe401d8dfb4739b6904a57392ba2566d086d180' # dorado version 1.0.2+c758d2f6
export MODKIT_SIF="docker://ontresearch/modkit:shaa7bf2b62946eeb7646b9b9d60b892edfc3b3a52c" # mod_kit 0.3.3
# srun -A chsi -p chsi      --mem=20G -c 10 apptainer exec $DORADO_SIF_PATH dorado --version
# srun -A chsi -p chsi      --mem=20G -c 10 apptainer exec $MODKIT_SIF modkit --version
#-----------------------------
# export REFERENCE_GENOME_URL="https://ftp.ncbi.nlm.nih.gov/genomes/all/GCA/013/426/205/GCA_013426205.1_ASM1342620v1/GCA_013426205.1_ASM1342620v1_genomic.fna.gz"
# export REFERENCE_GENOME_MD5="7d53077d823457819dd369b43e70ddf5  GCA_013426205.1_ASM1342620v1_genomic.fna.gz"

# export REFERENCE_GENOME_URL_2="https://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/000/840/245/GCF_000840245.1_ViralProj14204/GCF_000840245.1_ViralProj14204_genomic.fna.gz"
# export REFERENCE_GENOME_MD5_2="7e74fba2c9e1107f228dbb12bada5c1c  GCF_000840245.1_ViralProj14204_genomic.fna.gz


# NCBI
# https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7842015/
# https://ftp.ncbi.nlm.nih.gov/genomes/all/GCA/013/426/205/GCA_013426205.1_ASM1342620v1/GCA_013426205.1_ASM1342620v1_genomic.gtf.gz
# https://www.ncbi.nlm.nih.gov/assembly/GCA_013426205.1/?shouldredirect=false
# https://www.ncbi.nlm.nih.gov/datasets/genome/GCA_013426205.1/
# 
# Ensembl Fungi
# https://fungi.ensembl.org/Metarhizium_brunneum_gca_013426205/Info/Index
# https://ftp.ensemblgenomes.ebi.ac.uk/pub/fungi/release-58/fasta/fungi_ascomycota5_collection/metarhizium_brunneum_gca_013426205/dna_index/Metarhizium_brunneum_gca_013426205.ASM1342620v1.dna.toplevel.fa.gz
# http://ftp.ensemblgenomes.org/pub/fungi/release-58/fasta/fungi_ascomycota5_collection/metarhizium_brunneum_gca_013426205/dna/Metarhizium_brunneum_gca_013426205.ASM1342620v1.dna.toplevel.fa.gz
# https://ftp.ensemblgenomes.ebi.ac.uk/pub/fungi/release-58/gff3/fungi_ascomycota5_collection/metarhizium_brunneum_gca_013426205/Metarhizium_brunneum_gca_013426205.ASM1342620v1.58.gff3.gz
#-----------------------------
export CPUJOB_PARTITION="chsi,common,scavenger"
export GPUJOB_PARTITION="biostat-gpu,gpu-common,scavenger-gpu"
export GPU_ACCOUNT="biostat"
export CPU_ACCOUNT="chsi"

# export GPUJOB_GPUS="RTX2080:1"
export GPUJOB_GPUS="5000_ada"
#-----------------------------
SCRATCH_DIR="/cwork/${USER}"
export FAST_LOCAL_STORAGE="/scratch"

# generated by make_combined_mb_lambda_genome.sh
export REFERENCE_GENOME="${SCRATCH_DIR}/genomes/mb_lambda_fusion/Mbrunneum4556_phage_lambda.fna.gz"

export OUTDIR="${SCRATCH_DIR}/bsf_results/full/bsf_batch2_full_4mC_6mA"
export POD5_DIR="/cwork/josh/rawdata_from_aws/20250722_BSF_batch2/BSF_Batch2"
#-----------------------------
# dorado duplex will fail if a requested model is not available for your dataset (e.g. 6mA)
# find model names with: 
# srun --mem=20G -c 2 -A chsi -p chsi apptainer exec oras://gitlab-registry.oit.duke.edu/granek-lab/granek-container-images/dorado-simg:v0_6_1 dorado download --list
# dorado won't do 4mC_5mC and 5mC_5hmC simultaneously
# export DORADO_MODEL_STRING="sup,5mC_5hmC,6mA"
export DORADO_MODEL_STRING="sup,4mC_5mC,6mA"
#-----------------------------
# find demux information with: 
# srun --mem=5G -c 2 -A chsi -p chsi apptainer exec oras://gitlab-registry.oit.duke.edu/granek-lab/granek-container-images/dorado-simg:v0_6_1 dorado demux --help
export KIT_NAME="SQK-NBD114-96" # for options run see --kit-name in `dorado demux --help`

#--------------
## Sample Sheet
#--------------
export SAMPLE_SHEET="/cwork/josh/rawdata_from_aws/20250722_BSF_batch2/20250722_BSF_batch2_sample_sheet_expanded.csv"
